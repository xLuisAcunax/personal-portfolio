---
import Layout from "../layouts/Layout.astro";
import ContactForm from "../components/ContactForm.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { SITE } from "../content/config.ts";

type Exp = CollectionEntry<"experience">;

const [expAll, projectsAll] = await Promise.all([
  getCollection("experience"),
  getCollection("projects"),
]);

const toKey = (x: Exp) =>
  x.data.end === "present" ? "9999-12" : (x.data.end ?? x.data.start);
const exp = [...expAll].sort((a, b) => toKey(b).localeCompare(toKey(a)));

const stacks = Array.from(
  new Set(projectsAll.flatMap((p) => p.data.stack.map((s) => s.toLowerCase())))
).sort();

const chipBase = "px-2 py-0.5 rounded-full border text-xs chip";
const chipColors = [
  "text-emerald-300 border-emerald-800/50",
  "text-cyan-300 border-cyan-800/50",  
  "text-indigo-300 border-indigo-800/50",
  "text-fuchsia-300 border-fuchsia-800/50",
  "text-amber-300 border-amber-800/50",
  "text-violet-300 border-violet-800/50",
  "text-rose-300 border-rose-800/50",
  "text-sky-300 border-sky-800/50",
];
// Welcome to Astro! Wondering what to do next? Check out the Astro documentation at https://docs.astro.build
// Don't want to use any of this? Delete everything in this file, the `assets`, `components`, and `layouts` directories, and start fresh.
---

<Layout title="Luis Acuña— Software Developer">
  <!-- HERO con parallax real y rendimiento -->
  <section class="relative overflow-hidden min-h-[85svh] sm:min-h-[86svh]">
    <!-- Capa fondo (parallax lento) -->
    <div id="bg" class="absolute inset-0 -z-10">
		<!-- Imagen controlada -->
		<picture class="pointer-events-none select-none absolute top-1/2 -translate-y-1/2
                
				min-[1921px]:right-[10vw] min-[1921px]:w-[80%]
				max-[1920px]:right-[10vw] max-[1920px]:w-[80%]
				max-[1190px]:right-[-12vw] max-[1190px]:w-[130%]
				max-[930px]:right-[-18vw] max-[930px]:w-[185%] 
				max-[430px]:right-[-18vw] max-[430px]:w-[230%]
				max-[360px]:right-[-8vw] max-[360px]:w-[100%]">
			<!-- Solo cargar la foto en >= 360px -->
			<source media="(min-width: 360px)" srcset="/about-me.png" />
			<!-- Fallback 1x1 transparente para móviles -->
			<img alt="" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="w-full h-auto object-contain" />
		</picture>
      <!-- Gradiente por encima de la foto -->
      <div
        class="absolute inset-0 z-10"
        style="background: radial-gradient(1200px 600px at 15% 35%, rgba(30,41,59,.55), transparent 60%);"
      >
      </div>
    </div>

    <!-- Contenido -->
    <div class="mx-auto max-w-5xl px-6
            pt-[48svh] pb-0
			max-[359px]:pt-0 max-[359px]:pb-0 max-[359px]:py-32 

            min-[1190px]:py-44">
      <h1
        class="text-5xl md:text-7xl font-semibold tracking-tight leading-[0.95]"
      >
        Luis Acuña
      </h1>
      <h2 class="rol inline-block will-change-transform
           text-[clamp(12px,5vw,52px)] sm:text-2xl md:text-3xl font-semibold leading-tight">
		Full-Stack Developer
	  </h2>
      <p class="mt-5 max-w-xl text-neutral-300">
        <span class="text-yellow-200">12+</span> años creando aplicaciones <span
          class="text-yellow-200">limpias</span
        >, <span class="text-yellow-200">escalables</span> y bien probadas. Aquí
        dejo mi trabajo, experiencias y lo que estoy construyendo ahora.
      </p>

      <!-- Social icons -->
      <div class="mt-6 flex items-center gap-5">
        <!-- GitHub -->
        <a
          href={SITE.github}
          aria-label="GitHub de Luis Acuña"
          target="_blank"
          rel="noopener noreferrer"
          class="text-neutral-400 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded"
        >
          <span class="sr-only">GitHub</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 fill-current">
            <path d="M12 .5a12 12 0 0 0-3.8 23.4c.6.1.8-.2.8-.6v-2.1c-3.4.7-4.1-1.6-4.1-1.6-.5-1.3-1.1-1.7-1.1-1.7-.9-.6.1-.6.1-.6 1 .1 1.5 1 1.5 1 .9 1.6 2.4 1.1 3 .9.1-.7.3-1.1.6-1.4-2.7-.3-5.4-1.3-5.4-6 0-1.3.5-2.3 1.2-3.1-.1-.3-.5-1.6.1-3.3 0 0 1-.3 3.3 1.3a11.6 11.6 0 0 1 6.1 0c2.2-1.6 3.3-1.3 3.3-1.3.6 1.7.2 3 .1 3.3.8.8 1.2 1.8 1.2 3.1 0 4.6-2.7 5.6-5.4 5.9.4.4.7 1 .7 2.1v3.1c0 .4.2.8.8.6A12 12 0 0 0 12 .5z"/>
          </svg>
        </a>

        <!-- LinkedIn -->
        <a
          href={SITE.linkedin}
          aria-label="LinkedIn de Luis Acuña"
          target="_blank"
          rel="noopener noreferrer"
          class="text-neutral-400 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded"
        >
          <span class="sr-only">LinkedIn</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 fill-current">
            <path d="M4.98 3.5A2.5 2.5 0 1 0 5 8.5a2.5 2.5 0 0 0-.02-5zM3 9h4v12H3zM9 9h3.8v1.7h.1c.5-.9 1.8-1.8 3.7-1.8 4 0 4.7 2.6 4.7 6V21h-4v-5.3c 0-1.3 0-3-1.8-3s-2.1 1.4-2.1 2.9V21H9z"/>
          </svg>
        </a>
      </div>

      <div class="mt-8 flex gap-4">
        <a
          href="#proyectos"
          class="rounded-xl px-5 py-3 bg-white text-black font-medium hover:translate-y-[1px] transition"
          >Ver proyectos</a
        >
        <a
          href="#contacto"
          class="rounded-xl px-5 py-3 border border-neutral-700 hover:border-neutral-500"
          >Hablemos</a
        >
      </div>
    </div>

    <!-- Capa medio (parallax medio) -->
    <div
      id="dots"
      class="pointer-events-none absolute inset-0 -z-10 opacity-40"
    >
      <!-- puntitos decorativos -->
      <canvas id="dots-canvas" class="w-full h-full"></canvas>
    </div>

    <!-- Capa foreground (parallax rápido sutil) -->
    <div
      id="glow"
      class="pointer-events-none absolute -z-10 left-1/2 top-[20%] h-[40vh] w-[80vw] -translate-x-1/2 rounded-full blur-3xl opacity-30"
      style="background: radial-gradient(closest-side, #6ee7ff 0%, transparent 70%);"
    >
    </div>
  </section>

  <!-- Secciones -->
  <section id="experiencia" class="mx-auto max-w-5xl px-6 py-24">
    <h2 class="text-2xl font-semibold mb-8 text-yellow-200">Experiencia</h2>

    <div class="relative border-l border-neutral-800 pl-6">
      {
        exp.map((item, i) => (
          <article class="group mb-10 reveal" style={`--delay:${i * 80}ms`}>
            <h3 class="font-medium text-blue-300">
              {item.data.company} — {item.data.role}
            </h3>
            <p class="text-sm opacity-70">
              {item.data.start} – {item.data.end ?? "—"}
            </p>
            <div
              class="prose prose-invert mt-2 opacity-90 max-w-none"
              set:html={item.body}
            />
            {(item.data.stack ?? []).slice(0, 4).map((t, i) => (
              <span class={`${chipBase} ${chipColors[i % chipColors.length]}`}>
                {t}
              </span>
            ))}
          </article>
        ))
      }
    </div>
  </section>

  <section id="proyectos" class="mx-auto max-w-5xl px-6 py-24">
    <h2 class="text-2xl font-semibold mb-4 text-yellow-200">Proyectos</h2>

    <!-- Filtros -->
    <div id="filters" class="flex flex-wrap gap-2 mb-6">
      <button data-tag="all" class="chip chip--active">Todas</button>
      {
        stacks.map((tag) => (
          <button data-tag={tag} class="chip">
            {tag}
          </button>
        ))
      }
    </div>

    <!-- Grid -->
    <div id="projects-grid" class="grid md:grid-cols-2 gap-6 items-stretch">
      {
        projectsAll.map((p, i) => (
          	<a
				href={`/projects/${p.slug}/`}
				class="card tilt reveal rounded-2xl border border-neutral-800 bg-neutral-950 hover:border-neutral-600
						transition p-4 flex flex-col min-h-[320px]"
				style={`--delay:${i * 80}ms`}
				data-tags={p.data.stack.map((s) => s.toLowerCase()).join(",")}
				>
				<div class="aspect-video rounded-xl bg-neutral-900 mb-3 relative overflow-hidden">
					{p.data.cover ? (
					<img src={p.data.cover} alt={p.data.title} loading="lazy"
						class="absolute inset-0 w-full h-full object-cover" />
					) : (
					<div class="h-full w-full grid place-items-center opacity-60 text-sm">Sin imagen</div>
					)}
				</div>

				<h3 class="font-medium text-blue-300">{p.data.title}</h3>
				<p class="opacity-80 text-sm">
					{p.data.summary}
				</p>

				<!-- Chips: empujados al fondo -->
				<div class="mt-auto pt-3 flex flex-wrap gap-1 text-xs opacity-70">
					{p.data.stack.slice(0, 4).map((t, i) => (
					<span class={`${chipBase} ${chipColors[i % chipColors.length]}`}>
						{t}
					</span>
					))}
				</div>
			</a>
        ))
      }
    </div>
  </section>

  <ContactForm action="https://formspree.io/f/TU_ID_AQUI" />

  <script type="module">
    // Parallax ligero, 60fps y sin librerías
    const lerp = (a, b, t) => a + (b - a) * t;
    let y = 0,
      sy = 0;
    const bg = document.getElementById("bg");
    const dots = document.getElementById("dots");
    const glow = document.getElementById("glow");

    const raf = () => {
      sy = lerp(sy, window.scrollY || 0, 0.12);
      // distintas velocidades
      bg.style.transform = `translateY(${-(sy * 0.06)}px)`;
      dots.style.transform = `translateY(${-(sy * 0.12)}px)`;
      glow.style.transform = `translate(-50%, ${-(sy * 0.18)}px)`;
      requestAnimationFrame(raf);
    };
    requestAnimationFrame(raf);

    // Reveal on scroll (IntersectionObserver)
    const io = new IntersectionObserver(
      (entries) => {
        for (const e of entries) {
          if (e.isIntersecting) e.target.classList.add("is-visible");
        }
      },
      { rootMargin: "-10% 0px -10% 0px", threshold: 0.05 }
    );
    document.querySelectorAll(".reveal").forEach((el) => io.observe(el));

    // Canvas decorativo minimal
    const c = document.getElementById("dots-canvas");
    const ctx = c.getContext("2d");
    const resize = () => {
      c.width = c.clientWidth;
      c.height = c.clientHeight;
      draw();
    };
    const draw = () => {
      ctx.clearRect(0, 0, c.width, c.height);
      for (let i = 0; i < 120; i++) {
        const x = Math.random() * c.width,
          y = Math.random() * c.height,
          r = Math.random() * 1.5;
        ctx.globalAlpha = 0.5 * Math.random();
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
      }
    };
    addEventListener("resize", resize);
    resize();

    // Tilt (ligero)
    const clamp = (n, min, max) => Math.min(Math.max(n, min), max);
    document.querySelectorAll(".tilt").forEach((card) => {
      let rID = null;
      const onMove = (e) => {
        const rect = card.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        const rx = clamp((0.5 - y) * 10, -10, 10);
        const ry = clamp((x - 0.5) * 10, -10, 10);
        card.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) translateZ(0)`;
      };
      const reset = () => {
        card.style.transform = "";
      };
      card.addEventListener("mousemove", onMove);
      card.addEventListener("mouseleave", reset);
    });

    // Filtros por stack
    const filters = document.getElementById("filters");
    const grid = document.getElementById("projects-grid");
    filters?.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;
      filters
        .querySelectorAll("button")
        .forEach((b) => b.classList.remove("chip--active"));
      btn.classList.add("chip--active");
      const tag = btn.dataset.tag;
      grid.querySelectorAll("[data-tags]").forEach((card) => {
        const tags = card.getAttribute("data-tags")?.split(",") ?? [];
        const show = tag === "all" || tags.includes(tag);
        card.style.display = show ? "" : "none";
      });
    });
  </script>

  <style is:global>
    @media (prefers-reduced-motion: reduce) {
      .reveal {
        transition: none;
        transform: none !important;
        opacity: 1 !important;
      }
      #bg,
      #dots,
      #glow {
        transform: none !important;
      }
      .tilt {
        transform: none !important;
      }
    }
    /* Animación de entrada suave */
    .reveal {
      opacity: 0;
      transform: translateY(8px);
      transition:
        opacity 0.5s ease,
        transform 0.5s ease;
      transition-delay: var(--delay, 0ms);
    }
    .reveal.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .chip {
      border: 1px solid #27272a;
      padding: 0.4rem 0.7rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      opacity: 0.85;
    }
    .chip:hover {
      opacity: 1;
    }
    .chip--active {
      background: #fff;
      color: #000;
      border-color: #fff;
    }
    .rol { color: #55a5d3; /* quita font-size aquí */ }
	.rol::before { content: "{"; margin-right: .25ch; color: #d4da86; }
	.rol::after  { content: "}"; margin-left:  .25ch; color: #d4da86; }
    .chip {
      margin-right: 5px;
    }
    /* Tipografía (Inter + Newsreader si quieres acentos editoriales) */
    @font-face {
      font-family: "Inter Variable";
      src: url("/node_modules/@fontsource-variable/inter/files/inter-latin-wght-normal.woff2")
        format("woff2-variations");
      font-weight: 100 900;
      font-display: swap;
    }
    @font-face {
      font-family: "Newsreader Variable";
      src: url("/node_modules/@fontsource-variable/newsreader/files/newsreader-latin-wght-normal.woff2")
        format("woff2-variations");
      font-weight: 200 800;
      font-display: swap;
    }
    :root {
      --sans: "Inter Variable", system-ui, -apple-system, Segoe UI, Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "Segoe UI Emoji";
      --serif: "Newsreader Variable", ui-serif, Georgia;
    }
    h1,
    h2,
    h3 {
      font-family: var(--sans);
    }
    body {
      font-family: var(--sans);
    }
  </style>
</Layout>
